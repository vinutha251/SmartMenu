<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçΩÔ∏è Smart Restaurant Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --light: #f8fafc; --dark: #1e293b; --gray: #64748b;
            --gray-light: #e2e8f0; --border-radius: 12px;
            --shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        body { background: linear-gradient(135deg, #f0f4ff 0%, #fdf2f8 100%); min-height: 100vh; padding: 20px; }
        .app-container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.1); min-height: calc(100vh - 40px); display: flex; flex-direction: column; }
        .app-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 20px 30px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 700; }
        .app-nav { background: var(--light); padding: 0 20px; border-bottom: 1px solid var(--gray-light); display: flex; }
        .nav-btn { padding: 15px 20px; background: none; border: none; color: var(--gray); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
        .nav-btn:hover { color: var(--primary); background: rgba(99, 102, 241, 0.05); }
        .nav-btn.active { color: var(--primary); background: white; }
        .main-content { flex: 1; padding: 30px; background: #f8fafc; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn { padding: 10px 20px; border: none; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow); }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .table-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); transition: var(--transition); border: 2px solid transparent; }
        .table-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .menu-card { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); }
        .menu-image { height: 180px; width: 100%; overflow: hidden; }
        .menu-image img { width: 100%; height: 100%; object-fit: cover; }
        .cart-summary { background: white; border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); margin-top: 20px; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--gray-light); }
        .summary-row.total { border-bottom: none; font-size: 1.3rem; font-weight: 700; color: var(--dark); margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--gray-light); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal { background: white; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; }
        .split-options { display: flex; gap: 10px; margin-bottom: 25px; }
        .split-option { flex: 1; padding: 15px; border: 2px solid var(--gray-light); border-radius: var(--border-radius); cursor: pointer; text-align: center; }
        .split-option.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .people-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .person-card { background: white; border: 2px solid var(--gray-light); border-radius: var(--border-radius); padding: 15px; }
        .person-amount { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin: 10px 0; }
        .payment-methods { display: flex; gap: 8px; margin-top: 10px; }
        .payment-method { flex: 1; padding: 8px; border: 2px solid var(--gray-light); border-radius: 6px; background: none; cursor: pointer; }
        .payment-method.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        /* Quantity Controls */
        .quantity-control { display: flex; align-items: center; gap: 10px; }
        .quantity-btn { width: 30px; height: 30px; border: none; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .quantity-btn:hover { background: var(--primary-dark); }
        .quantity-value { font-weight: 600; min-width: 30px; text-align: center; }
        /* Dashboard Styles */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); text-align: center; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; margin: 0 auto 15px; }
        .stat-icon.revenue { background: linear-gradient(135deg, #10b981, #34d399); }
        .stat-icon.pending { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .stat-icon.orders { background: linear-gradient(135deg, #8b5cf6, #a78bfa); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .stat-label { color: var(--gray); font-size: 0.95rem; }
        .payment-table { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow); }
        .payment-table table { width: 100%; border-collapse: collapse; }
        .payment-table th { background: var(--light); padding: 15px; text-align: left; color: var(--gray); font-weight: 600; }
        .payment-table td { padding: 15px; border-bottom: 1px solid var(--gray-light); }
        .payment-status { padding: 5px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-cash { background: #dbeafe; color: #1e40af; }
        /* Item assignment styles */
        .item-assignment-table { background: #f8fafc; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto; }
        .assignment-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .assigned-item { background: rgba(99, 102, 241, 0.1); }
        .unassigned-item { opacity: 0.7; }
        @media (max-width: 768px) {
            .tables-grid, .menu-grid { grid-template-columns: 1fr; }
            .app-nav { overflow-x: auto; }
            .nav-btn { padding: 12px 15px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="logo"><i class="fas fa-utensils"></i> Smart Restaurant Pro</div>
            <div><i class="fas fa-user"></i></div>
        </div>
        <nav class="app-nav" id="appNav"></nav>
        <main class="main-content" id="mainContent"></main>
    </div>

    <script>
        // Restaurant Data
        const restaurantData = {
            tables: [
                { id: 1, number: 1, status: 'available', capacity: 2 },
                { id: 2, number: 2, status: 'occupied', capacity: 4 },
                { id: 3, number: 3, status: 'reserved', capacity: 2 },
                { id: 4, number: 4, status: 'available', capacity: 6 },
                { id: 5, number: 5, status: 'occupied', capacity: 4 },
                { id: 6, number: 6, status: 'available', capacity: 2 },
            ],
            menuItems: [
                { id: 1, name: "Masala Dosa", description: "Crispy rice crepe with spiced potatoes", price: 12.99, image: "https://images.unsplash.com/photo-1631452180519-c014fe946bc7?w=400&h=300&fit=crop", category: "South Indian" },
                { id: 2, name: "Truffle Pizza", description: "Wood-fired pizza with truffle oil", price: 24.99, image: "https://images.unsplash.com/photo-1604068549290-dea0e4a305ca?w=400&h=300&fit=crop", category: "Italian" },
                { id: 3, name: "Pad Thai", description: "Stir-fried rice noodles", price: 18.99, image: "https://images.unsplash.com/photo-1559314809-2b99056a8c4a?w=400&h=300&fit=crop", category: "Thai" },
                { id: 4, name: "Chocolate Cake", description: "Warm chocolate cake", price: 10.99, image: "https://images.unsplash.com/photo-1624353365286-3f8d62dadadf?w=400&h=300&fit=crop", category: "Desserts" },
                { id: 5, name: "Grilled Salmon", description: "Atlantic salmon", price: 28.99, image: "https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=400&h=300&fit=crop", category: "Seafood" },
                { id: 6, name: "Beef Burger", description: "Premium Angus beef", price: 16.99, image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400&h=300&fit=crop", category: "Burgers" },
            ]
        };

        // App State
        let appState = {
            tables: [...restaurantData.tables],
            cart: [],
            selectedTable: null,
            activeView: 'tables',
            splitPeople: [],
            splitType: 'equal',
            payments: [],
            authenticated: false,
            password: "admin123",
            itemAssignments: {}
        };

        // Initialize App
        function initApp() {
            const saved = localStorage.getItem('restaurantState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appState = { ...appState, ...parsed };
                } catch(e) {}
            }
            if (localStorage.getItem('restaurantAuth') === 'true') {
                appState.authenticated = true;
            }
            if (appState.payments.length === 0) {
                appState.payments = [
                    { id: '1', tableNumber: 2, personName: 'John', amount: 45.50, status: 'paid_online', createdAt: new Date().toISOString() },
                    { id: '2', tableNumber: 5, personName: 'Emma', amount: 32.75, status: 'paid_cash', createdAt: new Date().toISOString() },
                    { id: '3', tableNumber: 3, personName: 'Mike', amount: 28.00, status: 'pending', createdAt: new Date().toISOString() }
                ];
            }
            renderNavigation();
            renderView();
        }

        function saveState() {
            localStorage.setItem('restaurantState', JSON.stringify({
                tables: appState.tables,
                cart: appState.cart,
                selectedTable: appState.selectedTable,
                payments: appState.payments
            }));
        }

        // Navigation
        function renderNavigation() {
            const nav = document.getElementById('appNav');
            if (appState.authenticated) {
                nav.innerHTML = `
                    <button class="nav-btn active" onclick="changeView('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>Dashboard
                    </button>
                    <button class="nav-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>Logout
                    </button>
                `;
            } else {
                nav.innerHTML = `
                    <button class="nav-btn ${appState.activeView === 'tables' ? 'active' : ''}" onclick="changeView('tables')">
                        <i class="fas fa-chair"></i>Tables
                    </button>
                    ${appState.selectedTable ? `
                        <button class="nav-btn ${appState.activeView === 'menu' ? 'active' : ''}" onclick="changeView('menu')">
                            <i class="fas fa-utensils"></i>Menu
                        </button>
                        <button class="nav-btn ${appState.activeView === 'cart' ? 'active' : ''}" onclick="changeView('cart')">
                            <i class="fas fa-shopping-cart"></i>Cart ${appState.cart.length > 0 ? `(${appState.cart.length})` : ''}
                        </button>
                    ` : ''}
                    <button class="nav-btn" onclick="showLoginModal()">
                        <i class="fas fa-user-tie"></i>Staff Login
                    </button>
                `;
            }
        }

        function changeView(view) {
            appState.activeView = view;
            renderNavigation();
            renderView();
        }

        function renderView() {
            const main = document.getElementById('mainContent');
            if (appState.authenticated) {
                main.innerHTML = renderDashboard();
            } else {
                switch(appState.activeView) {
                    case 'menu': main.innerHTML = renderMenu(); break;
                    case 'cart': main.innerHTML = renderCart(); break;
                    default: main.innerHTML = renderTables();
                }
            }
        }

        function renderTables() {
            return `
                <div>
                    <div class="page-header">
                        <h1><i class="fas fa-chair"></i> Tables</h1>
                        <button class="btn btn-primary" onclick="refreshTables()">
                            <i class="fas fa-sync-alt"></i>Refresh
                        </button>
                    </div>
                    <div class="tables-grid">
                        ${appState.tables.map(table => `
                            <div class="table-card" style="border-color: ${table.status === 'available' ? '#10b981' : table.status === 'occupied' ? '#ef4444' : '#f59e0b'}">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                                    <h3>Table ${table.number}</h3>
                                    <span style="padding:5px 12px; border-radius:20px; color:white; background:${table.status === 'available' ? '#10b981' : table.status === 'occupied' ? '#ef4444' : '#f59e0b'}">
                                        ${table.status}
                                    </span>
                                </div>
                                <div style="color:#64748b; margin-bottom:15px">
                                    <div><i class="fas fa-users"></i> ${table.capacity} people</div>
                                </div>
                                ${table.status === 'available' ? `
                                    <div style="display:flex; gap:10px">
                                        <button class="btn btn-primary" style="flex:1" onclick="selectTable(${table.id})">
                                            <i class="fas fa-check"></i>Select
                                        </button>
                                        <button class="btn" style="flex:1; background:#f59e0b; color:white" onclick="reserveTable(${table.id})">
                                            <i class="fas fa-calendar"></i>Reserve
                                        </button>
                                    </div>
                                ` : '<button class="btn" style="width:100%; background:#64748b; color:white" disabled>Not Available</button>'}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMenu() {
            return `
                <div>
                    <div class="page-header">
                        <h1><i class="fas fa-utensils"></i> Menu - Table ${appState.selectedTable?.number}</h1>
                        <button class="btn btn-primary" onclick="changeView('cart')">
                            <i class="fas fa-shopping-cart"></i>Cart (${appState.cart.length})
                        </button>
                    </div>
                    <div class="menu-grid">
                        ${restaurantData.menuItems.map(item => `
                            <div class="menu-card">
                                <div class="menu-image">
                                    <img src="${item.image}" alt="${item.name}">
                                </div>
                                <div style="padding:15px">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                                        <h3>${item.name}</h3>
                                        <div style="font-weight:700; color:#6366f1">$${item.price.toFixed(2)}</div>
                                    </div>
                                    <p style="color:#64748b; margin-bottom:10px">${item.description}</p>
                                    <div style="color:#6366f1; font-weight:600; margin-bottom:15px">${item.category}</div>
                                    <button class="btn btn-primary" style="width:100%" onclick="addToCart(${item.id})">
                                        <i class="fas fa-cart-plus"></i>Add to Cart
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCart() {
            if (appState.cart.length === 0) {
                return `
                    <div style="text-align:center; padding:60px 20px">
                        <div style="font-size:4rem; color:#e2e8f0; margin-bottom:20px"><i class="fas fa-shopping-cart"></i></div>
                        <h2 style="color:#64748b; margin-bottom:15px">Your cart is empty</h2>
                        <button class="btn btn-primary" onclick="changeView('menu')">
                            <i class="fas fa-utensils"></i>Browse Menu
                        </button>
                    </div>
                `;
            }
            
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
            const tax = subtotal * 0.08;
            const service = subtotal * 0.1;
            const total = subtotal + tax + service;
            
            return `
                <div>
                    <div class="page-header">
                        <h1><i class="fas fa-shopping-cart"></i> Your Order</h1>
                        <div>
                            <button class="btn" onclick="changeView('menu')" style="margin-right:10px">
                                <i class="fas fa-plus"></i>Add More
                            </button>
                            <button class="btn" style="background:#ef4444; color:white" onclick="clearCart()">
                                <i class="fas fa-trash"></i>Clear
                            </button>
                        </div>
                    </div>
                    <div style="background:white; border-radius:12px; padding:20px; box-shadow:var(--shadow); margin-bottom:20px">
                        ${appState.cart.map((item, index) => {
                            const quantity = item.quantity || 1;
                            const itemTotal = item.price * quantity;
                            return `
                                <div style="display:flex; align-items:center; padding:15px 0; border-bottom:1px solid #e2e8f0">
                                    <img src="${item.image}" style="width:80px; height:80px; border-radius:8px; object-fit:cover; margin-right:15px">
                                    <div style="flex:1">
                                        <h4>${item.name}</h4>
                                        <div style="color:#64748b">${item.category}</div>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:15px">
                                        <div class="quantity-control">
                                            <button class="quantity-btn" onclick="updateCartQuantity(${index}, -1)">-</button>
                                            <span class="quantity-value">${quantity}</span>
                                            <button class="quantity-btn" onclick="updateCartQuantity(${index}, 1)">+</button>
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:700; color:#6366f1">$${itemTotal.toFixed(2)}</div>
                                            <div style="font-size:0.9rem; color:#64748b">$${item.price.toFixed(2)} each</div>
                                        </div>
                                        <button onclick="removeFromCart(${index})" style="margin-left:10px; background:none; border:none; color:#ef4444; cursor:pointer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="cart-summary">
                        <div class="summary-row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>
                        <div class="summary-row"><span>Tax (8%)</span><span>$${tax.toFixed(2)}</span></div>
                        <div class="summary-row"><span>Service (10%)</span><span>$${service.toFixed(2)}</span></div>
                        <div class="summary-row total"><span>Total</span><span>$${total.toFixed(2)}</span></div>
                        <button class="btn btn-primary" style="width:100%; padding:15px; margin-top:20px" onclick="openSplitBillModal()">
                            <i class="fas fa-money-bill-wave"></i>Split Bill & Pay
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const pendingPayments = appState.payments.filter(p => p.status === 'pending');
            const completedPayments = appState.payments.filter(p => p.status !== 'pending');
            const totalRevenue = completedPayments.reduce((sum, p) => sum + p.amount, 0);
            const today = new Date().toDateString();
            const todayRevenue = completedPayments.filter(p => 
                new Date(p.createdAt).toDateString() === today
            ).reduce((sum, p) => sum + p.amount, 0);
            
            return `
                <div>
                    <div class="page-header">
                        <h1><i class="fas fa-tachometer-alt"></i> Restaurant Dashboard</h1>
                        <div>
                            <button class="btn btn-primary" onclick="generateReport()" style="margin-right:10px">
                                <i class="fas fa-file-export"></i>Export Report
                            </button>
                            <button class="btn" style="background:#ef4444; color:white" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>Logout
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-icon revenue">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value">$${todayRevenue.toFixed(2)}</div>
                            <div class="stat-label">Today's Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orders">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-value">${appState.tables.filter(t => t.status === 'occupied').length}</div>
                            <div class="stat-label">Occupied Tables</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value">${pendingPayments.length}</div>
                            <div class="stat-label">Pending Payments</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon orders">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-value">${appState.payments.length}</div>
                            <div class="stat-label">Total Orders</div>
                        </div>
                    </div>
                    
                    <div style="margin:40px 0">
                        <h2 style="margin-bottom:20px">Payment Tracking</h2>
                        <div class="payment-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Table</th>
                                        <th>Customer</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Time</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appState.payments.map(payment => `
                                        <tr>
                                            <td>#${payment.tableNumber}</td>
                                            <td>${payment.personName}</td>
                                            <td>$${payment.amount.toFixed(2)}</td>
                                            <td>
                                                <span class="payment-status status-${payment.status.replace('_', '-')}">
                                                    ${payment.status === 'paid_online' ? 'Paid Online' :
                                                      payment.status === 'paid_cash' ? 'Paid Cash' : 'Pending'}
                                                </span>
                                            </td>
                                            <td>${new Date(payment.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                            <td>
                                                ${payment.status === 'pending' ? `
                                                    <button class="btn" style="padding:6px 12px; font-size:0.85rem" onclick="markAsCash('${payment.id}')">
                                                        <i class="fas fa-money-bill"></i> Mark Cash
                                                    </button>
                                                ` : `
                                                    <span style="color:#10b981">
                                                        <i class="fas fa-check-circle"></i> Paid
                                                    </span>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${appState.payments.length === 0 ? `
                                        <tr>
                                            <td colspan="6" style="text-align:center; padding:40px; color:#64748b">
                                                No payments to display
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== SPLIT BILL BY ITEMS FUNCTIONALITY ==========

        function openSplitBillModal() {
            if (appState.cart.length === 0) {
                alert('Cart is empty!');
                return;
            }
            
            // Initialize people
            appState.splitPeople = [
                { id: 1, name: 'Person 1', amount: 0, paymentMethod: 'online', assignedItems: [] },
                { id: 2, name: 'Person 2', amount: 0, paymentMethod: 'online', assignedItems: [] }
            ];
            
            // Reset item assignments
            appState.itemAssignments = {};
            appState.splitPeople.forEach(p => p.assignedItems = []);
            
            // Auto-assign items initially
            autoAssignItems();
            calculateSplitAmounts();
            
            showSplitBillModal();
        }

        function showSplitBillModal() {
            const total = calculateCartTotal();
            const modalHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2><i class="fas fa-money-bill-wave"></i> Split Bill</h2>
                            <button class="btn" onclick="closeModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align:center; margin-bottom:20px">
                                <div style="font-size:2rem; font-weight:700; color:#6366f1">$${total.toFixed(2)}</div>
                                <div style="color:#64748b">Total Bill</div>
                            </div>
                            
                            <div class="split-options">
                                <div class="split-option ${appState.splitType === 'equal' ? 'active' : ''}" onclick="changeSplitType('equal')">
                                    <div style="font-size:1.5rem; margin-bottom:8px"><i class="fas fa-equals"></i></div>
                                    Equal Split
                                </div>
                                <div class="split-option ${appState.splitType === 'custom' ? 'active' : ''}" onclick="changeSplitType('custom')">
                                    <div style="font-size:1.5rem; margin-bottom:8px"><i class="fas fa-utensils"></i></div>
                                    By Items
                                </div>
                            </div>
                            
                            <!-- Item Assignment Table for Custom Split -->
                            ${appState.splitType === 'custom' ? `
                                <div style="margin-bottom:25px">
                                    <h3 style="margin-bottom:15px">Assign Items</h3>
                                    <div class="item-assignment-table">
                                        <table style="width:100%; border-collapse:collapse">
                                            <thead>
                                                <tr style="background:#e2e8f0">
                                                    <th style="padding:10px; text-align:left">Item</th>
                                                    <th style="padding:10px; text-align:right">Price</th>
                                                    ${appState.splitPeople.map((p, idx) => `
                                                        <th style="padding:10px; text-align:center">${p.name}</th>
                                                    `).join('')}
                                                    <th style="padding:10px; text-align:center; color:#64748b">Assigned To</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${appState.cart.map((item, itemIdx) => {
                                                    const quantity = item.quantity || 1;
                                                    let itemHTML = '';
                                                    for (let i = 0; i < quantity; i++) {
                                                        const unitIdx = itemIdx + '_' + i;
                                                        // Find which people have this item
                                                        const assignedPeople = appState.splitPeople.map((person, idx) => 
                                                            person.assignedItems.includes(unitIdx) ? idx : -1
                                                        ).filter(idx => idx !== -1);
                                                        
                                                        const rowClass = assignedPeople.length > 0 ? 'assigned-item' : 'unassigned-item';
                                                        const assignedNames = assignedPeople.map(idx => appState.splitPeople[idx].name).join(', ') || 'Not assigned';
                                                        
                                                        itemHTML += `
                                                            <tr class="${rowClass}" style="border-bottom:1px solid #e2e8f0">
                                                                <td style="padding:10px">${item.name} ${quantity > 1 ? `(${i + 1}/${quantity})` : ''}</td>
                                                                <td style="padding:10px; text-align:right">$${item.price.toFixed(2)}</td>
                                                                ${appState.splitPeople.map((person, personIdx) => `
                                                                    <td style="padding:10px; text-align:center">
                                                                        <input type="checkbox" class="assignment-checkbox"
                                                                               ${person.assignedItems.includes(unitIdx) ? 'checked' : ''}
                                                                               onchange="toggleItemAssignment('${unitIdx}', ${personIdx})">
                                                                    </td>
                                                                `).join('')}
                                                                <td style="padding:10px; text-align:center; font-size:0.9em; color:#64748b">
                                                                    ${assignedNames}
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }
                                                    return itemHTML;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="display:flex; gap:10px; margin-top:15px">
                                        <button class="btn" onclick="autoAssignItems()" style="flex:1">
                                            <i class="fas fa-robot"></i> Auto-Assign
                                        </button>
                                        <button class="btn" onclick="clearAssignments()" style="flex:1; background:#ef4444; color:white">
                                            <i class="fas fa-times"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="margin-bottom:25px">
                                <div style="display:flex; justify-content:space-between; margin-bottom:15px">
                                    <h3>People (${appState.splitPeople.length})</h3>
                                    <button class="btn" onclick="addPerson()">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                                <div class="people-grid">
                                    ${appState.splitPeople.map((person, index) => `
                                        <div class="person-card">
                                            <div style="display:flex; justify-content:space-between; margin-bottom:10px">
                                                <input type="text" value="${person.name}" onchange="updatePersonName(${index}, this.value)" style="border:none; font-weight:600; font-size:1em; width:120px">
                                                ${appState.splitPeople.length > 2 ? `
                                                    <button onclick="removePerson(${index})" style="background:none; border:none; color:#ef4444; cursor:pointer">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div class="person-amount">$${person.amount.toFixed(2)}</div>
                                            ${appState.splitType === 'custom' ? `
                                                <div style="font-size:0.9em; color:#64748b; margin:5px 0">
                                                    Items: ${person.assignedItems.length}
                                                </div>
                                            ` : ''}
                                            <div class="payment-methods">
                                                <button class="payment-method ${person.paymentMethod === 'online' ? 'active' : ''}" onclick="changePaymentMethod(${index}, 'online')">
                                                    QR
                                                </button>
                                                <button class="payment-method ${person.paymentMethod === 'cash' ? 'active' : ''}" onclick="changePaymentMethod(${index}, 'cash')">
                                                    Cash
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" style="width:100%; padding:15px" onclick="generatePaymentQRs()">
                                <i class="fas fa-qrcode"></i> Generate Payments
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function calculateSplitAmounts() {
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
            const tax = subtotal * 0.08;
            const service = subtotal * 0.1;
            const total = subtotal + tax + service;
            
            if (appState.splitType === 'equal') {
                // Equal split
                const perPerson = total / appState.splitPeople.length;
                appState.splitPeople.forEach(person => {
                    person.amount = Math.round(perPerson * 100) / 100;
                    person.assignedItems = []; // Clear for equal split
                });
            } else {
                // Custom split by items
                let assignedItemTotal = 0;
                
                // Reset amounts
                appState.splitPeople.forEach(person => {
                    person.amount = 0;
                });
                
                // Calculate based on assigned items (each unit is counted separately)
                appState.cart.forEach((item, itemIdx) => {
                    const quantity = item.quantity || 1;
                    for (let i = 0; i < quantity; i++) {
                        const unitIdx = itemIdx + '_' + i;
                        // Find people who have this unit assigned
                        const peopleWithUnit = appState.splitPeople.filter(person => 
                            person.assignedItems.includes(unitIdx)
                        );
                        
                        if (peopleWithUnit.length > 0) {
                            // Split unit price among assigned people
                            const unitShare = item.price / peopleWithUnit.length;
                            peopleWithUnit.forEach(person => {
                                person.amount += unitShare;
                                assignedItemTotal += unitShare;
                            });
                        }
                    }
                });
                
                if (assignedItemTotal > 0) {
                    // Add tax and service proportionally
                    appState.splitPeople.forEach(person => {
                        const proportion = person.amount / assignedItemTotal;
                        person.amount += (tax + service) * proportion;
                        person.amount = Math.round(person.amount * 100) / 100;
                    });
                } else {
                    // If no items assigned, split equally
                    const perPerson = total / appState.splitPeople.length;
                    appState.splitPeople.forEach(person => {
                        person.amount = Math.round(perPerson * 100) / 100;
                    });
                }
                
                // Adjust for rounding
                const sum = appState.splitPeople.reduce((s, p) => s + p.amount, 0);
                const diff = total - sum;
                if (Math.abs(diff) > 0.01) {
                    appState.splitPeople[appState.splitPeople.length - 1].amount += diff;
                    appState.splitPeople[appState.splitPeople.length - 1].amount = 
                        Math.round(appState.splitPeople[appState.splitPeople.length - 1].amount * 100) / 100;
                }
            }
        }

        function toggleItemAssignment(unitIdx, personIdx) {
            const person = appState.splitPeople[personIdx];
            const index = person.assignedItems.indexOf(unitIdx);
            
            if (index === -1) {
                // Add item to person
                person.assignedItems.push(unitIdx);
            } else {
                // Remove item from person
                person.assignedItems.splice(index, 1);
            }
            
            calculateSplitAmounts();
            updateSplitModal();
        }

        function autoAssignItems() {
            // Clear all assignments
            appState.splitPeople.forEach(p => p.assignedItems = []);
            
            // Assign items in round-robin fashion (each unit separately)
            let unitIndex = 0;
            appState.cart.forEach((item, itemIdx) => {
                const quantity = item.quantity || 1;
                for (let i = 0; i < quantity; i++) {
                    const unitIdx = itemIdx + '_' + i;
                    const personIdx = unitIndex % appState.splitPeople.length;
                    appState.splitPeople[personIdx].assignedItems.push(unitIdx);
                    unitIndex++;
                }
            });
            
            calculateSplitAmounts();
            updateSplitModal();
        }

        function clearAssignments() {
            if (confirm('Clear all item assignments?')) {
                appState.splitPeople.forEach(p => p.assignedItems = []);
                calculateSplitAmounts();
                updateSplitModal();
            }
        }

        function changeSplitType(type) {
            appState.splitType = type;
            if (type === 'equal') {
                appState.splitPeople.forEach(p => p.assignedItems = []);
            } else {
                autoAssignItems();
            }
            calculateSplitAmounts();
            updateSplitModal();
        }

        function updatePersonName(index, newName) {
            if (newName.trim()) {
                appState.splitPeople[index].name = newName.trim();
                updateSplitModal();
            }
        }

        function removePerson(index) {
            if (appState.splitPeople.length > 2) {
                const removed = appState.splitPeople.splice(index, 1)[0];
                // Recalculate without the removed person
                calculateSplitAmounts();
                updateSplitModal();
            }
        }

        function addPerson() {
            if (appState.splitPeople.length < 6) {
                const newPerson = {
                    id: appState.splitPeople.length + 1,
                    name: `Person ${appState.splitPeople.length + 1}`,
                    amount: 0,
                    paymentMethod: 'online',
                    assignedItems: []
                };
                appState.splitPeople.push(newPerson);
                
                if (appState.splitType === 'custom') {
                    autoAssignItems(); // Reassign items with new person
                } else {
                    calculateSplitAmounts();
                }
                updateSplitModal();
            }
        }

        function changePaymentMethod(index, method) {
            appState.splitPeople[index].paymentMethod = method;
            updateSplitModal();
        }

        function updateSplitModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
                showSplitBillModal();
            }
        }

        function generatePaymentQRs() {
            const onlinePayers = appState.splitPeople.filter(p => p.paymentMethod === 'online');
            
            if (onlinePayers.length === 0) {
                alert('Please select online payment for at least one person');
                return;
            }
            
            // Create payment records
            appState.splitPeople.forEach(person => {
                const paymentId = 'payment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                appState.payments.push({
                    id: paymentId,
                    tableNumber: appState.selectedTable.number,
                    personName: person.name,
                    amount: person.amount,
                    paymentMethod: person.paymentMethod,
                    status: person.paymentMethod === 'cash' ? 'pending' : 'pending',
                    createdAt: new Date().toISOString()
                });
            });
            
            saveState();
            
            // Show QR codes
            let qrHTML = '<div style="margin-top:25px; border-top:1px solid #e2e8f0; padding-top:25px">';
            qrHTML += '<h3 style="margin-bottom:15px">QR Codes for Payment</h3>';
            qrHTML += '<div class="qr-grid">';
            
            onlinePayers.forEach(person => {
                qrHTML += `
                    <div style="background:white; border:2px solid #e2e8f0; border-radius:12px; padding:15px; text-align:center">
                        <div style="font-weight:600; margin-bottom:8px">${person.name}</div>
                        <div style="font-size:1.3rem; font-weight:700; color:#6366f1; margin:10px 0">$${person.amount.toFixed(2)}</div>
                        <div style="width:120px; height:120px; background:linear-gradient(45deg,#6366f1,#4f46e5); margin:10px auto; border-radius:8px; display:flex; align-items:center; justify-content:center; color:white">
                            <div style="text-align:center">
                                <div style="font-size:2rem">üì±</div>
                                <div style="font-size:0.8rem">Scan to Pay</div>
                            </div>
                        </div>
                        <div style="font-size:0.9rem; color:#64748b; margin-top:10px">Table ${appState.selectedTable.number}</div>
                    </div>
                `;
            });
            
            qrHTML += '</div>';
            
            // Add cash payment instructions
            const cashPayers = appState.splitPeople.filter(p => p.paymentMethod === 'cash');
            if (cashPayers.length > 0) {
                qrHTML += `
                    <div style="margin-top:20px; padding:15px; background:#fef3c7; border-radius:8px;">
                        <h4 style="color:#92400e; margin-bottom:10px"><i class="fas fa-money-bill"></i> Cash Payments</h4>
                        ${cashPayers.map(p => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(146,64,14,0.1)">
                                <span>${p.name}</span>
                                <span style="font-weight:600">$${p.amount.toFixed(2)}</span>
                            </div>
                        `).join('')}
                        <div style="margin-top:10px; font-size:0.9em; color:#92400e">
                            Please collect cash from these customers
                        </div>
                    </div>
                `;
            }
            
            qrHTML += '</div>';
            
            const modal = document.querySelector('.modal-body');
            if (modal) {
                const btn = modal.querySelector('.btn-primary');
                if (btn) btn.style.display = 'none';
                modal.insertAdjacentHTML('beforeend', qrHTML);
            }
            
            // Add success message
            setTimeout(() => {
                const modal = document.querySelector('.modal-body');
                if (modal) {
                    modal.insertAdjacentHTML('beforeend', `
                        <div style="margin-top:20px; padding:15px; background:#d1fae5; border-radius:8px; color:#065f46; text-align:center">
                            <i class="fas fa-check-circle"></i> Payments generated successfully! Redirecting...
                        </div>
                    `);
                }
            }, 500);
            
            // Clear cart and close after 3 seconds
            setTimeout(() => {
                appState.cart = [];
                saveState();
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
                changeView('tables');
                alert('Payment split completed! Table ' + appState.selectedTable.number + ' is now available.');
            }, 3000);
        }

        function closeModal(event) {
            if (event?.target?.classList.contains('modal-overlay')) {
                document.querySelector('.modal-overlay').remove();
            } else {
                const modal = document.querySelector('.modal-overlay');
                if (modal) modal.remove();
            }
        }

        // Helper Functions
        function calculateCartTotal() {
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
            const tax = subtotal * 0.08;
            const service = subtotal * 0.1;
            return subtotal + tax + service;
        }

        function selectTable(tableId) {
            const table = appState.tables.find(t => t.id === tableId);
            if (table && table.status === 'available') {
                appState.selectedTable = table;
                table.status = 'occupied';
                saveState();
                changeView('menu');
            }
        }

        function reserveTable(tableId) {
            const table = appState.tables.find(t => t.id === tableId);
            if (table) {
                table.status = 'reserved';
                saveState();
                renderView();
            }
        }

        function addToCart(itemId) {
            const item = restaurantData.menuItems.find(i => i.id === itemId);
            if (item) {
                // Check if item already exists in cart
                const existingIndex = appState.cart.findIndex(cartItem => cartItem.id === item.id);
                if (existingIndex !== -1) {
                    // Increase quantity
                    appState.cart[existingIndex].quantity = (appState.cart[existingIndex].quantity || 1) + 1;
                } else {
                    // Add new item with quantity 1
                    appState.cart.push({ ...item, quantity: 1 });
                }
                saveState();
                renderNavigation();
            }
        }

        function updateCartQuantity(index, change) {
            const item = appState.cart[index];
            if (item) {
                const newQuantity = (item.quantity || 1) + change;
                if (newQuantity < 1) {
                    removeFromCart(index);
                } else {
                    item.quantity = newQuantity;
                    saveState();
                    renderView();
                }
            }
        }

        function removeFromCart(index) {
            appState.cart.splice(index, 1);
            saveState();
            renderView();
        }

        function clearCart() {
            if (appState.cart.length === 0 || !confirm('Clear cart?')) return;
            appState.cart = [];
            saveState();
            renderView();
        }

        function refreshTables() {
            appState.tables.forEach(t => {
                if (t.status === 'occupied' && Math.random() > 0.7) t.status = 'available';
            });
            saveState();
            renderView();
        }

        function markAsCash(paymentId) {
            const payment = appState.payments.find(p => p.id === paymentId);
            if (payment) {
                payment.status = 'paid_cash';
                saveState();
                renderView();
            }
        }

        function generateReport() {
            const totalRevenue = appState.payments.filter(p => p.status !== 'pending').reduce((sum, p) => sum + p.amount, 0);
            const report = `
                RESTAURANT REPORT
                =================
                Generated: ${new Date().toLocaleString()}
                
                Summary:
                ‚Ä¢ Total Orders: ${appState.payments.length}
                ‚Ä¢ Completed Payments: ${appState.payments.filter(p => p.status !== 'pending').length}
                ‚Ä¢ Pending Payments: ${appState.payments.filter(p => p.status === 'pending').length}
                ‚Ä¢ Total Revenue: $${totalRevenue.toFixed(2)}
                ‚Ä¢ Occupied Tables: ${appState.tables.filter(t => t.status === 'occupied').length}
                
                Recent Payments:
                ${appState.payments.slice(-5).map(p => 
                    `- ${p.personName}: $${p.amount.toFixed(2)} (${p.status === 'pending' ? 'Pending' : 'Paid'})`
                ).join('\n')}
            `;
            
            alert('Report generated!\n\n' + report);
        }

        function showLoginModal() {
            const modalHTML = `
                <div class="modal-overlay" onclick="closeModal(event)">
                    <div class="modal" onclick="event.stopPropagation()" style="max-width:400px">
                        <div class="modal-header">
                            <h2>Staff Login</h2>
                            <button class="btn" onclick="closeModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align:center; margin-bottom:20px">
                                <div style="width:60px; height:60px; background:linear-gradient(135deg,#6366f1,#4f46e5); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:white; margin:0 auto 15px">
                                    <i class="fas fa-user-tie"></i>
                                </div>
                                <p>Enter password to access dashboard</p>
                            </div>
                            <input type="password" id="loginPassword" class="form-input" placeholder="Password: admin123" style="margin-bottom:15px; width:100%; padding:12px; border:2px solid #e2e8f0; border-radius:8px">
                            <button class="btn btn-primary" style="width:100%; padding:12px" onclick="attemptLogin()">
                                <i class="fas fa-sign-in-alt"></i>Login
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function attemptLogin() {
            const input = document.getElementById('loginPassword');
            if (input && input.value === appState.password) {
                appState.authenticated = true;
                localStorage.setItem('restaurantAuth', 'true');
                closeModal();
                changeView('dashboard');
            } else {
                alert('Incorrect password. Try: admin123');
            }
        }

        function logout() {
            appState.authenticated = false;
            localStorage.removeItem('restaurantAuth');
            changeView('tables');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
